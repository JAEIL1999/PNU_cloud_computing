<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>모니터링 대시보드</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="container">

    <!-- 왼쪽 사이드 메뉴 -->
    <!-- 사이드 메뉴 -->
    <aside class="sidebar">
      <h2>📁 보기 선택</h2>
      <button onclick="switchView('overview')">📊 전체 대시보드</button>
      <button onclick="switchView('per-server')">🖥️ 서버별 보기</button>
      <button onclick="switchView('autoscale')">📈 오토스케일링</button>

      <!-- 부하 테스트 버튼은 그대로 고정 -->
      <button onclick="startStressTest()">🔥 부하 테스트</button>

      <p id="status">상태: 대기 중</p>
    </aside>


    <!-- 메인 콘텐츠 -->
    <main class="main">
      <!-- 전체 대시보드 뷰 -->
      <div class="view" id="view-overview">
        <h1>📊 전체 서버 상태</h1>
        <iframe src="http://localhost:3000/d-solo/...전체패널URL...&refresh=5s" width="100%" height="300"></iframe>
      </div>

      <!-- 서버별 보기 뷰 -->
      <div class="view" id="view-per-server" style="display:none;">
        <h1>🖥️ 서버별 상태</h1>
        <div id="server-list" class="server-list"></div>
        <iframe
          src="http://localhost:3000/d-solo/17602b6b-5a1d-4818-937b-ce9669523b29/new-dashboard?orgId=1&from=1748412339883&to=1748433939883&timezone=browser&panelId=3&__feature.dashboardSceneSolo"
          width="100%" height="200" frameborder="0"></iframe>
      </div>

      <!-- 오토스케일링 뷰 -->
      <div class="view" id="view-autoscale" style="display:none;">
        <h1>📈 오토스케일링 상태</h1>
        <iframe src="http://localhost:3000/d-solo/...오토스케일패널URL...&refresh=5s" width="100%" height="300"></iframe>
      </div>

      <!-- 부하 테스트 뷰 -->
      <div class="view" id="view-test" style="display:none;">
        <h1>🔥 부하 테스트</h1>
        <button onclick="startStressTest()">테스트 시작</button>
      </div>
    </main>
  </div>

  <script>
    function switchView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
      document.getElementById(`view-${viewId}`).style.display = 'block';

      if (viewId === 'per-server') {
        fetchServerList();
      }
    }

    function startStressTest() {
      const status = document.getElementById("status");
      status.innerText = "📡 부하 주는 중...";
      let count = 0;

      const interval = setInterval(() => {
        fetch("http://localhost:5000/")
          .then(() => {
            count++;
            status.innerText = `📊 요청 횟수: ${count}`;
            if (count >= 100) {
              clearInterval(interval);
              status.innerText = "✅ 완료";
            }
          })
          .catch(() => {
            status.innerText = "❌ 실패!";
            clearInterval(interval);
          });
      }, 100);
    }

    function fetchServerList() {
      fetch('/api/instances') // 추후 Flask에서 이 API 구현 필요
        .then(res => res.json())
        .then(instances => {
          const container = document.getElementById('server-list');
          container.innerHTML = '';

          instances.forEach(name => {
            const panel = document.createElement('div');
            panel.className = 'panel';
            panel.innerHTML = `
              <h3>🖥️ ${name}</h3>
              <iframe src="http://localhost:3000/d-solo/...패널ID&var-server=${name}&refresh=5s"
                      width="450" height="250"></iframe>
            `;
            container.appendChild(panel);
          });
        })
        .catch(err => {
          console.error('서버 리스트 불러오기 실패:', err);
        });
    }

    window.onload = () => switchView('overview');
  </script>
</body>

</html>